<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Three.js + Cannon.js</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script type="module">
        import * as THREE from 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.module.js';
        import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.128.0/examples/jsm/loaders/GLTFLoader.js';
        import * as CANNON from 'https://cdn.jsdelivr.net/npm/cannon-es/dist/cannon-es.js';

        let scene, camera, renderer, world;
        let model, modelBody;
        let floorBody;

        // Controls for movement
        const controls = { left: false, right: false, up: false, down: false };

        init();
        animate();

        function init() {
            // Scene and Camera
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 10);

            // Renderer
            renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // Light
            const light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(5, 10, 5);
            scene.add(light);

            // Physics world
            world = new CANNON.World();
            world.gravity.set(0, -9.82, 0);

            // Floor
            const floorGeometry = new THREE.PlaneGeometry(20, 20);
            const floorMaterial = new THREE.MeshStandardMaterial({ color: 0x888888 });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);

            const floorShape = new CANNON.Plane();
            floorBody = new CANNON.Body({ mass: 0 });
            floorBody.addShape(floorShape);
            floorBody.quaternion.setFromEuler(-Math.PI / 2, 0, 0);
            world.addBody(floorBody);

            // Walls
            createWall(10, 1, 0, Math.PI / 2); // Left Wall
            createWall(-10, 1, 0, -Math.PI / 2); // Right Wall
            createWall(0, 1, -10, Math.PI); // Back Wall

            // GLTF Model
            const loader = new GLTFLoader();
            loader.load('Static/Car/car.glb', (gltf) => {
                model = gltf.scene;
                model.scale.set(1, 1, 1);
                scene.add(model);

                const shape = new CANNON.Box(new CANNON.Vec3(0.5, 0.5, 0.5));
                modelBody = new CANNON.Body({ mass: 1 });
                modelBody.addShape(shape);
                modelBody.position.set(0, 1, 0);
                world.addBody(modelBody);
            });

            // Event Listeners for movement
            setupControls();
        }

        function createWall(x, y, z, rotationY) {
            const wallGeometry = new THREE.BoxGeometry(20, 5, 0.5);
            const wallMaterial = new THREE.MeshStandardMaterial({ color: 0x555555 });
            const wall = new THREE.Mesh(wallGeometry, wallMaterial);
            wall.position.set(x, y, z);
            wall.rotation.y = rotationY;
            scene.add(wall);

            const wallShape = new CANNON.Box(new CANNON.Vec3(10, 2.5, 0.25));
            const wallBody = new CANNON.Body({ mass: 0 });
            wallBody.addShape(wallShape);
            wallBody.position.set(x, y, z);
            wallBody.quaternion.setFromEuler(0, rotationY, 0);
            world.addBody(wallBody);
        }

        function setupControls() {
            const buttons = {
                up: document.createElement('button'),
                down: document.createElement('button'),
                left: document.createElement('button'),
                right: document.createElement('button')
            };

            Object.keys(buttons).forEach(direction => {
                const btn = buttons[direction];
                btn.textContent = direction;
                btn.style.position = 'absolute';
                btn.style.width = '50px';
                btn.style.height = '50px';
                btn.style.backgroundColor = 'lightblue';

                switch (direction) {
                    case 'up':
                        btn.style.top = '10px';
                        btn.style.left = '50%';
                        btn.style.transform = 'translateX(-50%)';
                        break;
                    case 'down':
                        btn.style.bottom = '10px';
                        btn.style.left = '50%';
                        btn.style.transform = 'translateX(-50%)';
                        break;
                    case 'left':
                        btn.style.bottom = '60px';
                        btn.style.left = '10px';
                        break;
                    case 'right':
                        btn.style.bottom = '60px';
                        btn.style.right = '10px';
                        break;
                }

                btn.addEventListener('touchstart', () => controls[direction] = true);
                btn.addEventListener('touchend', () => controls[direction] = false);
                document.body.appendChild(btn);
            });
        }

        function animate() {
            requestAnimationFrame(animate);

            // Update physics world
            world.step(1 / 60);

            if (model && modelBody) {
                // Apply controls to move the model
                const force = 5;
                if (controls.up) modelBody.velocity.z = -force;
                if (controls.down) modelBody.velocity.z = force;
                if (controls.left) modelBody.velocity.x = -force;
                if (controls.right) modelBody.velocity.x = force;

                model.position.copy(modelBody.position);
                model.quaternion.copy(modelBody.quaternion);
            }

            renderer.render(scene, camera);
        }

    </script>
</head>
<body></body>
</html>
