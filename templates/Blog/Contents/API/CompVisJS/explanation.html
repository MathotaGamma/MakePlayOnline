<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <title>CompVisJS - Explanation</title>
    <script src="https://makeplayonline.onrender.com/Static/API/CompVisJS/1.02.02/CompVisJS.js"></script>
  </head>
  <body>
    <h1>CompVisJS</h1>
    APIのURLは<b>https://makeplayonline.onrender.com/Static/API/CompVisJS/1.02.02/CompVisJS.js</b>です。
    <main>
      <p>
        Web版のEditorは<a href="./Editor">こちら</a>
      </p>
      <h2>メソッド一覧</h2>
      <p>
        C,cはnew CompVis(~,~);で作成したCompVisクラス変数、<br>
        xは実数、nは整数、lは実数値を二つ持った配列([x,y])とする。
      </p>
      <ul>
        <li>
          引数ありのメソッド
          <ul>
            <li>C.round(n)</li>
            <li>C.add(c)</li>
            <li>C.dif(c)</li>
            <li>C.pro(c)</li>
            <li>C.div(c)</li>
            <li>C.log_n(x)</li>
            <li>C.pow_by(c)</li>
            <li>C.pow_of(c)</li>
            <li>C.rotate(x)</li>
          </ul>
        </li>
        <li>
          引数なしのメソッド
          <ul>
            <li>C.value</li>
            <li>C.str</li>
            <li>C.real</li>
            <li>C.imag</li>
            <li>C.conj</li>
            <li>C.abs</li>
            <li>C.arg</li>
            <li>C.log</li>
            <li>C.exp</li>
          </ul>
        </li>
        <li>
          静的メソッド
          <ul>
            <li>CompVis._list,CompVis._list_ja</li>
            <li>CompVis._value</li>
            <li>CompVis._str</li>
            <li>CompVis._round(c,n)</li>
            <li>CompVis._toComp(l)</li>
          </ul>
        </li>
        <li>
          Graph関連
          <ul>
            <li>CompVis._create_canvas(element)</li>
            <li>CompVis._graph(id_ctx,func,start,end,step,params)</li>
            <li>CompVis._re_graph(data)</li>
          </ul>
        </li>
      </ul>

      <h2>メソッドの詳細</h2>
      <ul>
        <li>
          <h3>引数ありのメソッド</h3>
          <ul>
            <li>
              <h4>C.round(n)</h4>
              <p>
                Cの実部、虚部をそれぞれ特定の桁数で四捨五入する。<br>
                n&gt;0の場合、小数第n位で四捨五入する。<br>
                n=0の場合、そのまま四捨五入して整数値にする。<br>
                n&lt;0の場合、10<sup>n</sup>の位で四捨五入する。
              </p>
            </li>
            <li>
              <h4>C.add(c)</h4>
              <p>
                Cにcを足した値を返す<br>
                例:<br>
                <js-window>
const C = new CompVis(1,2);
const c = new CompVis(-2,1);
console.log(C.add(c).str);
                </js-window>
              </p>
            </li>
            <li>
              <h4>C.dif(c)</h4>
              <p>
                Cからcを引いた値を返す。<br>
                例:<br>
                <js-window>
const C = new CompVis(1,2);
const c = new CompVis(-2,1);
console.log(C.dif(c).str);
                </js-window>
              </p>
            </li>
            <li>
              <h4>C.pro(c)またはC.pro(x)</h4>
              <p>
                Cを cまたはx倍した値を返す。<br>
                引数が実数の場合はCの実部と虚部両方がx倍される。<br>
                例:<br>
                <js-window>
const C = new CompVis(-1,3);
const c = new CompVis(2,1.5);
const x = 3;
                  
console.log(C.pro(c).str); //C*c
console.log(C.pro(x).str); //C*x
                </js-window>
              </p>
            </li>
          </ul>
        </li>
      </ul>
      
    </main>
    <!--<script>
      class JSwindow extends HTMLElement {
  constructor() {
    super();
    // Shadow DOMを作成
    const shadow = this.attachShadow({ mode: "open" });

    // テキストエリア
    const textarea = document.createElement("textarea");
    textarea.rows = 5;
    textarea.cols = 40;
    textarea.textContent = this.textContent.trim();

    // 実行ボタン
    const button = document.createElement("button");
    button.textContent = "実行";

    // 結果表示
    const output = document.createElement("pre");
    output.style.cssText = "background: #f4f4f4; padding: 10px; border: 1px solid #ddd;";

    // CompVisJS.jsを動的に読み込む
    /*const script = document.createElement("script");
    script.src = "https://makeplayonline.onrender.com/Static/API/CompVisJS/1.02.02/CompVisJS.js";
    script.onerror = () => {
      output.textContent = "APIを読み込めませんでした。";
    };
    document.head.appendChild(script);*/

    // Worker用のコード
    const workerCode = `
      importScripts('https://makeplayonline.onrender.com/Static/API/CompVisJS/1.02.02/CompVisJS.js');

      // Worker内でconsole.logをオーバーライド
      self.consoleLog = function(message) {
        self.postMessage({ type: 'log', message: message });
      };

      // console.logの代わりに自分の実装を使用
      console.log = function(...args) {
        self.consoleLog(args.join(" "));
      };

      self.onmessage = function(event) {
        const { code } = event.data;

        try {
          // ユーザーコードを実行（CompVisJSを利用可能）
          const result = eval(code); // ユーザーコードの実行
          self.postMessage({ success: true, result: result });
        } catch (error) {
          self.postMessage({ success: false, error: error.message });
        }
      };
    `;

    // WorkerをBlob URLから作成
    const blob = new Blob([workerCode], { type: "application/javascript" });
    const workerUrl = URL.createObjectURL(blob);

    // ボタン押下時の処理
    button.addEventListener("click", () => {
      const code = textarea.value;
      const worker = new Worker(workerUrl);
      let isTimeout = false;

      // タイムアウト設定（3秒後に停止）
      const timeout = setTimeout(() => {
        isTimeout = true;
        worker.terminate();
        output.textContent = "タイムアウト: コードの実行が長すぎます。";
      }, 3000);

      // Workerからの結果を処理
      worker.onmessage = (event) => {
        clearTimeout(timeout); // タイムアウト解除
        if (isTimeout) return;

        const { success, result, error, type, message } = event.data;
        if (type === 'log') {
          // Workerからのconsole.logの出力を受け取る
          output.textContent += message + '\\n';
        } else if (success) {
          output.textContent = `結果: ${result}`;
        } else {
          output.textContent = `エラー: ${error}`;
        }
        worker.terminate();
      };

      // Workerにコードを送信
      worker.postMessage({ code });
    });

    // 要素をShadow DOMに追加
    shadow.appendChild(textarea);
    shadow.appendChild(document.createElement("br"));
    shadow.appendChild(button);
    shadow.appendChild(output);
  }
}

// カスタム要素を登録
customElements.define("js-window", JSwindow);

    </script>-->
    <script>
      class JSWindow extends HTMLElement {
  constructor() {
    super();
    // Shadow DOMを作成
    const shadow = this.attachShadow({ mode: "open" });

    // テキストエリア
    const textarea = document.createElement("textarea");
    textarea.rows = 5;
    textarea.cols = 40;
    textarea.textContent = this.textContent.trim();

    // 実行ボタン
    const button = document.createElement("button");
    button.textContent = "実行";

    // 結果表示
    const output = document.createElement("pre");
    output.style.cssText = "background: #f4f4f4; padding: 10px; border: 1px solid #ddd; white-space: pre-wrap;";

    // Worker用のコード
    const workerCode = `
      // CompVisJSのインポート
      importScripts('https://makeplayonline.onrender.com/Static/API/CompVisJS/1.02.02/CompVisJS.js');

      self.onmessage = function(event) {
        const { code } = event.data;

        // console.logをキャプチャする
        const logs = [];
        const originalLog = console.log;
        console.log = function(...args) {
          logs.push(args.join(" "));
        };

        try {
          // ユーザーコードを実行
          const result = eval(code);
          logs.forEach(log => self.postMessage({ type: 'log', message: log }));
          self.postMessage({ type: 'result', success: true, result: result });
        } catch (error) {
          self.postMessage({ type: 'result', success: false, error: error.message });
        } finally {
          // console.logを元に戻す
          console.log = originalLog;
        }
      };
    `;

    // WorkerをBlob URLから作成
    const blob = new Blob([workerCode], { type: "application/javascript" });
    const workerUrl = URL.createObjectURL(blob);

    // ボタン押下時の処理
    button.addEventListener("click", () => {
      // スマートクォートを通常のクォートに変換
      const code = textarea.value.replace(/“|”/g, '"').replace(/‘|’/g, "'");

      const worker = new Worker(workerUrl);
      let isTimeout = false;

      // タイムアウト設定（3秒後に停止）
      const timeout = setTimeout(() => {
        isTimeout = true;
        worker.terminate();
        output.innerHTML += "タイムアウト: コードの実行が長すぎます。<br>";
      }, 3000);

      // Workerからの結果を処理
      worker.onmessage = (event) => {
        clearTimeout(timeout); // タイムアウト解除
        if (isTimeout) return;

        const { type, success, result, error, message } = event.data;

        if (type === "log") {
          // Workerからのconsole.logの出力を追記
          output.innerHTML += `${message}<br>`;
        } else if (type === "result") {
          if (success) {
            if(result != undefined) output.innerHTML += `結果: ${result}<br>`;
          } else {
            output.innerHTML += `エラー: ${error}<br>`;
          }
          worker.terminate();
        }
      };

      // 出力をクリアしてから実行
      output.innerHTML = "";
      // Workerにコードを送信
      worker.postMessage({ code });
    });

    // 要素をShadow DOMに追加
    shadow.appendChild(textarea);
    shadow.appendChild(document.createElement("br"));
    shadow.appendChild(button);
    shadow.appendChild(output);
  }
}

// カスタム要素を登録
customElements.define("js-window", JSWindow);
    </script>
  </body>
</html>
